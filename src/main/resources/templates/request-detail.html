<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="'Vacation • ' + ${req.requester.name}">Vacation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 1) Bootstrap first -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 2) Then your request-detail stylesheet (with cache-bust) -->
    <link th:href="@{/css/request-detail.css(v=${#dates.createNow().time})}" rel="stylesheet">
</head>

<body class="vc-body">
<div class="vc-top-glow"></div>

<!-- Flash messages -->
<div th:if="${success}" class="alert alert-success validation alert-dismissible fade show" role="alert">
    <span class="icon me-2" aria-hidden="true">✓</span>
    <span th:text="${success}">Saved.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="container py-5">
    <!-- Back -->
    <a href="/" class="btn vc-btn-ghost btn-sm mb-3">← Back</a>

    <!-- Header -->
    <header class="mb-2">
        <h1 class="vc-title mb-1" th:text="${req.requester.name}">Name</h1>
        <p class="vc-subtitle mb-0">
            Requested:
            <b th:text="${#temporals.format(req.startDate, 'yyyy-MM-dd')}"></b>
            <span class="vc-arrow">→</span>
            <b th:text="${#temporals.format(req.endDate, 'yyyy-MM-dd')}"></b>
        </p>
    </header>

    <!-- Selector card -->
    <section class="vc-card mb-4">
        <div class="vc-card-header">
            <!--   <span class="vc-dot"></span> -->
             <!--   Choose your name to cover an account -->
          </div>
          <div class="row g-3">
              <div class="col-md-6">
                  <label class="form-label vc-label">
                      Select the TAM's name from the list below, then click <b>Assign</b> to complete the coverage:
                  </label>
                  <select id="coveringEmployee" class="form-select vc-select" required>
                      <option value="" selected disabled>Select TAM</option>
                      <option th:each="e : ${employees}" th:value="${e.id}" th:text="${e.name}"></option>
                  </select>
                  <div id="selectHint" class="form-text mt-2" style="color:#9aa3b2;">

                  </div>
              </div>
          </div>
      </section>

      <!-- Accounts -->
    <h3 class="vc-section-title mb-3">Accounts to cover</h3>

    <div class="table-responsive">
        <table class="table align-middle vc-table">
            <thead>
            <tr>
                <th>Account</th>
                <th>Status</th>
                <th style="width:180px;">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="a : ${accounts}">
                <td th:text="${a.name}">Account</td>

                <!-- Use coveredBy map: accountId -> covering employee name -->
                <td th:with="coverName=${coveredBy[a.id]}">
                    <span th:if="${coverName == null}">Pending Coverage</span>
                    <span th:if="${coverName != null}" th:text="'Covered by ' + ${coverName}">Covered</span>
                </td>

                <td th:with="coverName=${coveredBy[a.id]}">
                    <!-- Uncovered ⇒ show form -->
                    <form th:if="${coverName == null}"
                          th:action="@{/request/{id}/cover(id=${req.id})}"
                          method="post"
                          class="d-inline coverForm">
                        <input type="hidden" name="accountId" th:value="${a.id}">
                        <input type="hidden" name="coveringEmployeeId" class="coverEmpInput">
                        <button class="btn vc-btn-primary btn-sm coverBtn" type="submit" disabled title="Select your name first">
                            Assign
                        </button>
                    </form>

                    <!-- Covered ⇒ read-only indicator -->
                    <button th:if="${coverName != null}"
                            class="btn vc-btn-ghost btn-sm" disabled
                            th:text="'Covered by ' + ${coverName}">Covered</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Sync the hidden coveringEmployeeId and enable/disable Cover buttons
    const select = document.getElementById('coveringEmployee');
    let attempted = false;

    function updateCoverState() {
        const hasSelection = !!select.value;
        document.querySelectorAll('.coverEmpInput').forEach(i => i.value = hasSelection ? select.value : '');
        document.querySelectorAll('.coverBtn').forEach(btn => {
            btn.disabled = !hasSelection;
            btn.title = hasSelection ? '' : 'Select your name first';
        });
    }

    // Block submit if no selection and nudge the user
    document.querySelectorAll('form.coverForm').forEach(f => {
        f.addEventListener('submit', (e) => {
            if (!select.value) {
                e.preventDefault();
                if (!attempted) {
                    attempted = true;
                    document.getElementById('selectHint').style.color = '#facc15'; // warning yellow
                }
                select.focus();
            }
        });
    });

    select.addEventListener('change', () => {
        attempted = false;
        document.getElementById('selectHint').style.color = '#9aa3b2';
        updateCoverState();
    });

    // Init on load
    updateCoverState();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Auto-close any Bootstrap .alert after 3.5s
        document.querySelectorAll('.alert').forEach(el => {
            setTimeout(() => {
                try {
                    bootstrap.Alert.getOrCreateInstance(el).close(); // nice fade-out + remove
                } catch (_) {
                    // Fallback if Bootstrap isn't available for any reason
                    el.classList.remove('show');
                    setTimeout(() => el.remove(), 200);
                }
            }, 4000);
        });
    });
</script>

</body>
</html>
