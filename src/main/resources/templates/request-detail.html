<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="'Vacation • ' + ${req.requester.name}">Vacation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>


<body class="bg-dark text-light">
<!-- Flash messages -->
<div th:if="${success}" class="alert alert-success validation alert-dismissible fade show" role="alert">
    <span class="icon me-2" aria-hidden="true">✓</span>
    <span th:text="${success}">Saved.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="container py-4">
    <a href="/" class="btn btn-secondary btn-sm mb-3">← Back</a>

    <h2 class="mb-1" th:text="${req.requester.name}">Name</h2>
    <p class="mb-4">
        <span>Requested:</span>
        <b th:text="${#temporals.format(req.startDate, 'yyyy-MM-dd')}"></b>
        →
        <b th:text="${#temporals.format(req.endDate, 'yyyy-MM-dd')}"></b>
    </p>

    <!-- Who is covering -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <label class="form-label">Select your name from the list below, then click on cover for the account you wish to assist with:</label>
            <select id="coveringEmployee" class="form-select" required>
                <option value="" selected disabled>Select your name</option>
                <option th:each="e : ${employees}" th:value="${e.id}" th:text="${e.name}"></option>
            </select>
            <div id="selectHint" class="form-text text-muted mt-2">
                Select your name to enable the Cover buttons.
            </div>
        </div>
    </div>

    <h4 class="mt-3">Accounts to cover</h4>

    <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
            <thead>
            <tr>
                <th>Account</th>
                <th>Status</th>
                <th style="width:180px;">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="a : ${accounts}">
                <td th:text="${a.name}">Account</td>

                <!-- Use coveredBy map: accountId -> covering employee name -->
                <td th:with="coverName=${coveredBy[a.id]}">
                    <span th:if="${coverName == null}">Uncovered</span>
                    <span th:if="${coverName != null}" th:text="'Covered by ' + ${coverName}">Covered</span>
                </td>

                <td th:with="coverName=${coveredBy[a.id]}">
                    <!-- Uncovered ⇒ show form -->
                    <form th:if="${coverName == null}"
                          th:action="@{/request/{id}/cover(id=${req.id})}"
                          method="post"
                          class="d-inline coverForm">
                        <input type="hidden" name="accountId" th:value="${a.id}">
                        <input type="hidden" name="coveringEmployeeId" class="coverEmpInput">
                        <button class="btn btn-success btn-sm coverBtn" type="submit" disabled title="Select your name first">
                            Cover
                        </button>
                    </form>

                    <!-- Covered ⇒ show read-only indicator -->
                    <button th:if="${coverName != null}"
                            class="btn btn-outline-secondary btn-sm" disabled
                            th:text="'Covered by ' + ${coverName}">Covered</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Sync the hidden coveringEmployeeId and enable/disable Cover buttons
    const select = document.getElementById('coveringEmployee');
    let attempted = false;

    function updateCoverState() {
        const hasSelection = !!select.value;
        document.querySelectorAll('.coverEmpInput').forEach(i => i.value = hasSelection ? select.value : '');
        document.querySelectorAll('.coverBtn').forEach(btn => {
            btn.disabled = !hasSelection;
            btn.title = hasSelection ? '' : 'Select your name first';
        });
    }

    // Block submit if no selection and nudge the user
    document.querySelectorAll('form.coverForm').forEach(f => {
        f.addEventListener('submit', (e) => {
            if (!select.value) {
                e.preventDefault();
                if (!attempted) {
                    attempted = true;
                    document.getElementById('selectHint').classList.replace('text-muted', 'text-warning');
                }
                select.focus();
            }
        });
    });

    select.addEventListener('change', () => {
        attempted = false;
        document.getElementById('selectHint').classList.add('text-muted');
        document.getElementById('selectHint').classList.remove('text-warning');
        updateCoverState();
    });

    // Init on load
    updateCoverState();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/index.js}"></script>

</body>
</html>
